<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  const openModalBtn = document.getElementById('openModalBtn');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const eventModal = document.getElementById('eventModal');
  const cardsContainer = document.getElementById('cards');
  const form = document.getElementById('eventForm');

  // Abrir e fechar modal
  openModalBtn.addEventListener('click', () => eventModal.style.display = 'flex');
  closeModalBtn.addEventListener('click', () => eventModal.style.display = 'none');
  window.addEventListener('click', (e) => { if (e.target === eventModal) eventModal.style.display = 'none'; });

  // Configurar Flatpickr
  flatpickr("#data", {
    dateFormat: "d/m/Y",
    altInput: true,
    altFormat: "d/m/Y",
    locale: "pt"
  });

  // LocalStorage Helpers
  function saveEvents(events) {
    localStorage.setItem('tramontinEvents', JSON.stringify(events));
  }

  function loadEvents() {
    const events = localStorage.getItem('tramontinEvents');
    return events ? JSON.parse(events) : [];
  }

  function addCard(event, save = true) {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h2>${event.titulo}</h2>
      <div class="info"><span class="material-icons">event</span> ${event.data}</div>
      <div class="info"><span class="material-icons">schedule</span> ${event.hora}</div>
      <div class="info"><span class="material-icons">category</span> ${event.categoria || '-'}</div>
      <div class="info"><span class="material-icons">priority_high</span> ${event.prioridade || '-'}</div>
      <div class="info"><span class="material-icons">location_on</span> ${event.local || '-'}</div>
      <div class="description">${event.observacoes || 'Sem observações.'}</div>
      <span class="status ${event.status}">${event.status}</span>
      <button class="conclude-btn">✔️ Concluir</button>
    `;

    // Botão de concluir
    card.querySelector('.conclude-btn').addEventListener('click', () => {
      event.status = "Concluído";
      saveEvents(eventsList);
      renderCards();
    });

    cardsContainer.prepend(card);

    if (save) {
      eventsList.push(event);
      saveEvents(eventsList);
    }
  }

  function renderCards() {
    cardsContainer.innerHTML = '';
    eventsList.forEach(event => addCard(event, false));
  }

  const eventsList = loadEvents();
  renderCards();

  // Enviar novo evento
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
      titulo: document.getElementById('titulo').value.trim(),
      descricao: "",
      data: document.getElementById('data').value.trim(),
      hora: document.getElementById('hora').value.trim(),
      categoria: document.getElementById('categoria').value.trim(),
      prioridade: document.getElementById('prioridade').value.trim(),
      status: document.getElementById('status').value.trim(),
      local: document.getElementById('local').value.trim(),
      observacoes: document.getElementById('observacoes').value.trim()
    };

    if (!data.titulo || !data.data || !data.hora || !data.status) {
      alert("Por favor, preencha os campos obrigatórios.");
      return;
    }

    try {
      await fetch('https://script.google.com/macros/s/AKfycbwIvh_tZxyo6WZVa_UDp0Zb9C_ikQ9gdAWkqYICOKyZvXf62QMk7G7MFYHEVkokfZDR/exec', {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      alert('Evento adicionado com sucesso! ✅');
      addCard(data);
      eventModal.style.display = 'none';
      form.reset();
    } catch (error) {
      console.error('Erro ao enviar evento:', error);
      alert('Erro ao adicionar evento.');
    }
  });
</script>

</body>
</html>
